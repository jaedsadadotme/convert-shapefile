
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Quick Start - Leaflet</title>
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}
		input.file{
			border: 1px solid;
			padding: 7px;
			border-radius: 5px;
		}
		#map{
			width: 100%;
			height: 50vh; 
			position: relative;
			outline: none;
			border: 1px solid;
			border-radius: 15px;
		}
	</style>
</head>
<body>
	<div style="padding: 3rem;">
		<div>
			.Shp: 
			<input class="file" type="file" name="shp" id="shp">
			<br>
			<br>
			.Dbf: 
			<input class="file" type="file" name="dbf" id="dpf">
		</div>
		<br>
		<div>
			<button onclick="upload()">upload</button>
		</div>
		<div style="padding-top: 1rem;">
			<div id="map"></div>
		</div>
	</div>
</body>
<script>
	function upload() {
		const shp = document.querySelector('[name=shp]').files;
		const dbf = document.querySelector('[name=dbf]').files;
		const formData = new FormData();
		formData.append('shp', shp[0]);
		formData.append('dbf', dbf[0]);
		const url = "/api/data";
		let xhr = new XMLHttpRequest()
		
		xhr.open('POST', url, true)
		// xhr.setRequestHeader'Content-type', 'application/json; charset=UTF-8')
		xhr.send(formData);
		
		xhr.onload = function () {
			if(xhr.status === 200) {
				window.location.href = "?file="+xhr.responseText
			}
		}
	}

	function initMap(reverse,coordinates) {
		console.log(reverse);
		var container = L.DomUtil.get('map');
		if(container != null){
			container._leaflet_id = null;
		}
		var map = L.map('map').setView([coordinates[0][0][0],coordinates[0][0][1]], 9);

		var tiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map);
		var polygon;
		
		polygon = L.polygon(coordinates).addTo(map).bindPopup('I am a polygon.');

		map.fitBounds(polygon.getBounds());

		// function onMapClick(e) {
		// 	popup
		// 		.setLatLng(e.latlng)
		// 		.setContent('You clicked the map at ' + e.latlng.toString())
		// 		.openOn(map);
		// }

		// map.on('click', onMapClick);
	}
	
	function getData() {
		var xmlHttp = new XMLHttpRequest();
		if(window.location.search.substring(1).split("=")[0] == "file"){
			xmlHttp.open( "GET", "/api/data?file="+window.location.search.substring(1).split("=")[1], false ); // false for synchronous request
			xmlHttp.send( null );
		}else{
			xmlHttp.open( "GET", "/api/data?file=979fc2b6b36d3aae-polygon.shp", false ); // false for synchronous request
			xmlHttp.send( null );
		}
		data = JSON.parse(xmlHttp.responseText)
		let coordinates = []
		data.features.map(features=>{
			coordinates.push(features.geometry.coordinates)
		})
		//  = data.features[0].geometry.coordinates
		initMap(data.bbox.reverse(),coordinates)
		// return JSON.parse(xmlHttp.responseText)
	}
	getData()

</script>
</html>
